<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Jewellery POS – Ultra Gold Royal Edition (Updated)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* ------------------------------------------
   GLOBAL GOLD ROYAL THEME
-------------------------------------------*/
:root {
    --gold: #FFD37A;
    --gold-soft: #FFE9B8;
    --gold-hard: #D6A354;
    --dark: #050505;
    --glass: rgba(255,255,255,0.06);
    --glass-border: rgba(255,255,255,0.12);
}

body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(180deg, #000000, #0B0B0B, #101010);
    color: var(--gold-soft);
    min-height: 100vh;
}

/* ------------------------------------------
   HEADER
-------------------------------------------*/
.header {
    padding: 18px 10px;
    text-align: center;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--glass-border);
}

.header-title {
    font-size: 28px;
    font-weight: 700;
    color: var(--gold);
}

.header-tagline {
    font-size: 14px;
    opacity: 0.8;
}

/* ------------------------------------------
   GLASS NAVIGATION BAR
-------------------------------------------*/
.navbar {
    position: sticky;
    top: 0;
    z-index: 50;
    display: flex;
    overflow-x: auto;
    background: rgba(20,20,20,0.55);
    border-bottom: 1px solid var(--glass-border);
    backdrop-filter: blur(10px);
    gap: 6px;
    padding: 10px 6px;
}

.nav-btn {
    flex: 1 1 auto;
    white-space: nowrap;
    padding: 10px 14px;
    font-size: 14px;
    color: var(--gold-soft);
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    border: 1px solid var(--glass-border);
    transition: .25s;
    cursor: pointer;
}

.nav-btn:hover {
    background: rgba(255,255,255,0.12);
    color: var(--gold);
}

.nav-btn.active {
    background: linear-gradient(145deg, var(--gold), var(--gold-hard));
    color: #000;
    font-weight: bold;
    border-color: var(--gold-soft);
    box-shadow: 0 3px 10px rgba(255,175,50,0.4);
    transform: translateY(-2px);
}

/* ------------------------------------------
   UNIVERSAL CARD WITH GOLD FRAME + GLASS
-------------------------------------------*/
.gold-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 14px;
    padding: 18px;
    margin: 14px 0;
    box-shadow: 0 0 18px rgba(255,215,140,0.06);
    backdrop-filter: blur(6px);
}

/* ------------------------------------------
   INPUT (Floating Style)
-------------------------------------------*/
.form-group {
    position: relative;
    margin: 14px 0;
}

.form-input {
    width: 100%;
    padding: 12px 14px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--glass-border);
    color: var(--gold);
    border-radius: 8px;
    transition: .3s ease;
}

.form-input:focus {
    border-color: var(--gold);
    background: rgba(0,0,0,0.4);
    box-shadow: 0 0 8px rgba(255,214,120,0.4);
    outline: none;
}

.form-label {
    position: absolute;
    top: -8px;
    left: 14px;
    background: #000;
    padding: 0 6px;
    font-size: 12px;
    color: var(--gold-soft);
}

/* ------------------------------------------
   GOLD BUTTON
-------------------------------------------*/
.btn-gold {
    background: linear-gradient(140deg, var(--gold), var(--gold-hard));
    color: #000;
    font-weight: 700;
    padding: 12px 20px;
    width: 100%;
    border-radius: 10px;
    margin-top: 8px;
    box-shadow: 0 4px 14px rgba(255,200,100,0.35);
    border: none;
    transition: .25s ease;
    cursor: pointer;
}
.btn-gold:hover {
    background: linear-gradient(140deg, var(--gold-hard), var(--gold));
    transform: translateY(-2px);
}

/* ------------------------------------------
   PAGE HIDE/SHOW
-------------------------------------------*/
.page {
    display: none;
    padding: 18px;
}
.page.active {
    display: block;
}

/* ------------------------------------------
   TABLE GOLD THEME
-------------------------------------------*/
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: rgba(255,255,255,0.04);
    border-radius: 10px;
    overflow: hidden;
}
th {
    background: rgba(255,255,255,0.07);
    padding: 10px;
    color: var(--gold);
    font-size: 13px;
    text-align: left;
}
td {
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: var(--gold-soft);
    font-size: 13px;
}

/* ------------------------------------------
   MODAL (GLASS)
-------------------------------------------*/
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(5px);
    display: none;
    justify-content: center;
    align-items: center;
    padding: 14px;
    z-index: 100;
}
.modal-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 14px;
    padding: 20px;
    width: 100%;
    max-width: 420px;
    box-shadow: 0 0 24px rgba(255,210,120,0.2);
}

</style>
</head>

<body>

<div class="header">
    <h1 class="header-title"><i class="fa-solid fa-gem mr-2"></i> জুয়েলারি POS সিস্টেম</h1>
    <p class="header-tagline">Ultra Gold Royal Premium Edition</p>
</div>

<div class="navbar">
    <button class="nav-btn active" onclick="showPage('dashboard', this)">ড্যাশবোর্ড</button>
    <button class="nav-btn" onclick="showPage('purchase', this)">ক্রয়</button>
    <button class="nav-btn" onclick="showPage('sale', this)">বিক্রয়</button>
    <button class="nav-btn" onclick="showPage('mortgage', this)">বন্ধক</button>
    <button class="nav-btn" onclick="showPage('cash', this)">নগদ</button>
    <button class="nav-btn" onclick="showPage('reports', this)">রিপোর্ট</button>
    <button class="nav-btn" onclick="showPage('party', this)">পার্টি</button>
</div>

<div id="dashboard" class="page active">

    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-3 text-[var(--gold)]">
            <i class="fa-solid fa-chart-line mr-2"></i> সিস্টেমের সংক্ষিপ্ত তথ্য
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">

            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.04)]">
                <p class="text-sm text-gray-300">মোট বিনিয়োগ</p>
                <p id="total-investment" class="text-2xl font-bold text-green-400">৳ ০</p>
            </div>

            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.04)]">
                <p class="text-sm text-gray-300">মোট খরচ</p>
                <p id="total-expense" class="text-2xl font-bold text-red-400">৳ ০</p>
            </div>

            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.04)]">
                <p class="text-sm text-gray-300">বন্ধক বকেয়া</p>
                <p id="dashboard-total-mortgage" class="text-2xl font-bold text-blue-400">৳ ০</p>
            </div>

            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.04)]">
                <p class="text-sm text-gray-300">বন্ধক সুদ</p>
                <p id="dashboard-total-interest" class="text-2xl font-bold text-purple-400">৳ ০</p>
            </div>

        </div>
    </div>


    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-3 text-[var(--gold)]">বর্তমান স্বর্ণের স্টক</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

            <div>
                <p class="text-sm text-gray-400">স্টক (গ্রাম)</p>
                <p id="stock-grams" class="text-2xl font-bold text-yellow-300">০.০০ gm</p>
                <p id="stock-vori" class="text-xs text-gray-400">০ ভরি</p>
            </div>

            <div>
                <p class="text-sm text-gray-400">স্টকের বাজার মূল্য</p>
                <p id="stock-market-value" class="text-2xl font-bold text-yellow-300">৳ ০</p>
            </div>

            <div>
                <p class="text-sm mb-1 text-gray-400">স্বর্ণের বাজার মূল্য আপডেট (ভরি)</p>
                <form id="gold-rate-form" class="flex gap-2">
                    <input type="number" id="gold-rate-input"
                        class="form-input" placeholder="ভরি মূল্য">
                    <button type="submit" class="btn-gold text-sm w-1/3">আপডেট</button>
                </form>
                <p id="current-gold-rate" class="text-xs text-gray-500 mt-1">বর্তমান রেট: ৳ ০</p>
            </div>

        </div>
    </div>

    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-3 text-[var(--gold)]">সাম্প্রতিক লেনদেন</h2>
        <div class="overflow-x-auto">
            <table>
                <thead>
                    <tr>
                        <th>তারিখ</th>
                        <th>প্রকার</th>
                        <th>টাকা</th>
                        <th>বিবরণ</th>
                    </tr>
                </thead>
                <tbody id="recent-transactions-body">
                    <tr>
                        <td colspan="4" class="text-center text-gray-400">কোন লেনদেন নেই</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<div id="purchase" class="page">

    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-4 text-[var(--gold)]">
            <i class="fa-solid fa-cart-shopping mr-2"></i> স্বর্ণ/গহনা ক্রয়
        </h2>

        <form id="purchase-form">

            <h3 class="text-lg mb-2">ওজন ইনপুট</h3>
            <div class="grid grid-cols-4 gap-3">

                <div class="form-group">
                    <label class="form-label">ভরি</label>
                    <input type="number" id="purchase-vori" class="form-input" value="0" min="0">
                </div>

                <div class="form-group">
                    <label class="form-label">আনা</label>
                    <input type="number" id="purchase-ana" class="form-input" value="0" min="0" max="16">
                </div>

                <div class="form-group">
                    <label class="form-label">রতি</label>
                    <input type="number" id="purchase-roti" class="form-input" value="0" min="0" max="4">
                </div>

                <div class="form-group">
                    <label class="form-label">পয়েন্ট</label>
                    <input type="number" id="purchase-point" class="form-input" value="0" min="0" max="6">
                </div>
            </div>

            <p class="text-sm text-gray-300 mt-1">
                মোট গ্রাম: <span id="purchase-grams-output" class="text-yellow-300 font-bold">০</span> |
                মোট ভরি: <span id="purchase-vori-output" class="text-yellow-300 font-bold">০</span>
            </p>

            <div class="form-group">
                <label class="form-label">স্বর্ণের প্রকার</label>
                <input type="text" id="purchase-gold-type" class="form-input" placeholder="যেমন: ২২ ক্যারেট" required>
            </div>

            <div class="form-group">
                <label class="form-label">প্রতি ভরি মূল্য</label>
                <input type="number" id="purchase-price-per-vori" class="form-input" required min="1">
            </div>

            <div class="form-group">
                <label class="form-label">মেকিং চার্জ</label>
                <input type="number" id="purchase-making-charge" class="form-input" value="0" min="0">
            </div>

            <div class="form-group">
                <label class="form-label">সরবরাহকারী</label>
                <input type="text" id="purchase-supplier" class="form-input" placeholder="দোকানের নাম" required>
            </div>

            <p class="text-lg font-bold mt-3">
                মোট মূল্য: <span id="purchase-total-cost" class="text-green-400">৳ ০</span>
            </p>

            <button type="submit" class="btn-gold mt-4">ক্রয় জমা দিন</button>

        </form>

    </div>

</div>

<div id="sale" class="page">

    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-4 text-[var(--gold)]">
            <i class="fa-solid fa-bag-shopping mr-2"></i> স্বর্ণ/গহনা বিক্রয়
        </h2>

        <form id="sale-form">

            <h3 class="text-lg mb-2">ওজন ইনপুট</h3>

            <div class="grid grid-cols-4 gap-3">
                <div class="form-group">
                    <label class="form-label">ভরি</label>
                    <input type="number" id="sale-vori" class="form-input" value="0" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">আনা</label>
                    <input type="number" id="sale-ana" class="form-input" value="0" min="0" max="16">
                </div>
                <div class="form-group">
                    <label class="form-label">রতি</label>
                    <input type="number" id="sale-roti" class="form-input" value="0" min="0" max="4">
                </div>
                <div class="form-group">
                    <label class="form-label">পয়েন্ট</label>
                    <input type="number" id="sale-point" class="form-input" value="0" min="0" max="6">
                </div>
            </div>

            <p class="text-sm text-gray-300 mt-1">
                মোট গ্রাম: <span id="sale-grams-output" class="text-yellow-300 font-bold">০</span> |
                মোট ভরি: <span id="sale-vori-output" class="text-yellow-300 font-bold">০</span>
            </p>

            <div class="form-group">
                <label class="form-label">প্রতি ভরি বিক্রয় মূল্য</label>
                <input type="number" id="sale-price-per-vori" class="form-input" required min="1">
            </div>

            <div class="form-group">
                <label class="form-label">মেকিং চার্জ + লাভ</label>
                <input type="number" id="sale-charge-profit" class="form-input" value="0" min="0">
            </div>

            <div class="form-group">
                <label class="form-label">গ্রাহকের নাম</label>
                <input type="text" id="sale-customer" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">গ্রাহকের ফোন</label>
                <input type="text" id="sale-phone" class="form-input">
            </div>

            <p class="text-lg font-bold mt-3">
                মোট মূল্য: <span id="sale-total-cost" class="text-green-400">৳ ০</span>
            </p>

            <button type="submit" class="btn-gold mt-4">বিক্রয় জমা দিন</button>

        </form>
    </div>

</div>

<div id="mortgage" class="page">

    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-4 text-[var(--gold)]">
            <i class="fa-solid fa-hand-holding-dollar mr-2"></i> বন্ধক হিসাব
        </h2>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.05)]">
                <p class="text-sm text-gray-300">মোট বকেয়া মূলধন</p>
                <p id="total-mortgage-value" class="text-2xl font-bold text-blue-400">৳ ০</p>
            </div>
            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.05)]">
                <p class="text-sm text-gray-300">মোট বকেয়া সুদ</p>
                <p id="total-accrued-interest" class="text-2xl font-bold text-purple-400">৳ ০</p>
            </div>
        </div>

        <button onclick="document.getElementById('new-mortgage-modal').style.display='flex'"
            class="btn-gold text-sm w-full">নতুন বন্ধক যোগ করুন</button>

        <div class="overflow-x-auto mt-6">
            <table>
                <thead>
                    <tr>
                        <th>গ্রাহক</th>
                        <th>ওজন (ভরি)</th>
                        <th>ঋণ</th>
                        <th>সুদ (%)</th>
                        <th>শুরু</th>
                        <th>অ্যাকশন</th>
                    </tr>
                </thead>
                <tbody id="mortgage-list-body">
                    <tr>
                        <td colspan="6" class="text-center text-gray-400">কোনো বন্ধক নেই</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

</div>

<div id="cash" class="page">

    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-4 text-[var(--gold)]">
            <i class="fa-solid fa-money-bill-wave mr-2"></i> নগদ লেনদেন / বিনিয়োগ
        </h2>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.05)]">
                <p class="text-sm">মোট বিনিয়োগ</p>
                <p id="cash-total-investment" class="text-2xl font-bold text-green-400">৳ ০</p>
            </div>
            <div class="p-4 rounded-xl border border-[var(--glass-border)] bg-[rgba(255,255,255,0.05)]">
                <p class="text-sm">মোট খরচ</p>
                <p id="cash-total-expense" class="text-2xl font-bold text-red-400">৳ ০</p>
            </div>
        </div>

        <form id="cash-transaction-form">

            <div class="form-group">
                <label class="form-label">লেনদেনের ধরন</label>
                <select id="cash-type" class="form-input">
                    <option value="Investment">বিনিয়োগ (Cash In)</option>
                    <option value="Expense">খরচ (Cash Out)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">পরিমাণ</label>
                <input id="cash-amount" type="number" class="form-input" required min="1">
            </div>

            <div class="form-group">
                <label class="form-label">বিবরণ</label>
                <textarea id="cash-description" class="form-input" required></textarea>
            </div>

            <button type="submit" class="btn-gold mt-3">সংরক্ষণ করুন</button>
        </form>

        <div class="overflow-x-auto mt-6">
            <table>
                <thead>
                    <tr>
                        <th>তারিখ</th>
                        <th>ধরন</th>
                        <th>পরিমাণ</th>
                        <th>বিবরণ</th>
                    </tr>
                </thead>
                <tbody id="cash-list-body">
                    <tr>
                        <td colspan="4" class="text-center text-gray-400">কোনো লেনদেন নেই</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

</div>

<div id="reports" class="page">

    <div class="gold-card">
        <h2 class="text-xl font-semibold mb-4 text-[var(--gold)]">
            <i class="fa-solid fa-file-lines mr-2"></i> রিপোর্ট ও বিশ্লেষণ
        </h2>

        <form id="date-range-form" class="grid grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label">শুরুর তারিখ</label>
                <input id="start-date" type="date" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">শেষ তারিখ</label>
                <input id="end-date" type="date" class="form-input">
            </div>

            <button type="submit" class="btn-gold col-span-2">রিপোর্ট দেখুন</button>
        </form>

        <div id="filtered-report-output"
            class="p-4 mt-6 border border-[var(--glass-border)] rounded-xl">
            <p class="text-gray-400 text-center">তারিখ নির্বাচন করুন।</p>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-6">

            <div class="p-4 border border-[var(--glass-border)] rounded-xl">
                <p class="text-sm">মোট বিক্রয়</p>
                <p id="report-total-sale-revenue" class="text-xl font-bold text-blue-400">৳ ০</p>
            </div>

            <div class="p-4 border border-[var(--glass-border)] rounded-xl">
                <p class="text-sm">মোট ক্রয়</p>
                <p id="report-total-purchase-cost" class="text-xl font-bold text-red-400">৳ ০</p>
            </div>

            <div class="p-4 border border-[var(--glass-border)] rounded-xl col-span-2 bg-[rgba(255,255,255,0.07)]">
                <p class="text-sm">নেট লাভ/ক্ষতি</p>
                <p id="report-net-profit" class="text-3xl font-bold text-yellow-300">৳ ০</p>
            </div>

        </div>

    </div>

</div>

<div id="party" class="page">

    <div class="gold-card">

        <h2 class="text-xl font-semibold mb-4 text-[var(--gold)]">
            <i class="fa-solid fa-users mr-2"></i> গ্রাহক / সরবরাহকারী তালিকা
        </h2>

        <div class="form-group">
            <label class="form-label">পার্টির ধরন</label>
            <select id="party-type-filter" class="form-input" onchange="filterPartyList()">
                <option value="All">সব</option>
                <option value="Customer">গ্রাহক</option>
                <option value="Supplier">সরবরাহকারী</option>
            </select>
        </div>

        <div class="overflow-x-auto mt-6">
            <table>
                <thead>
                    <tr>
                        <th>নাম</th>
                        <th>ধরন</th>
                        <th>মোট লেনদেন</th>
                        <th>ফোন</th>
                    </tr>
                </thead>
                <tbody id="party-list-body">
                    <tr>
                        <td colspan="4" class="text-center text-gray-400">কোনো ডেটা নেই</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

</div>

<div id="new-mortgage-modal" class="modal">
    <div class="modal-card">

        <h2 class="text-lg font-semibold mb-4 text-[var(--gold)]">নতুন বন্ধক</h2>

        <form id="new-mortgage-form">

            <div class="form-group">
                <label class="form-label">গ্রাহকের নাম</label>
                <input id="mortgage-customer" type="text" class="form-input" required>
            </div>

            <h3 class="text-md font-semibold mb-2">ওজন ইনপুট</h3>

            <div class="grid grid-cols-4 gap-3">
                <div class="form-group">
                    <label class="form-label">ভরি</label>
                    <input id="mortgage-vori" type="number" value="0" class="form-input" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">আনা</label>
                    <input id="mortgage-ana" type="number" value="0" class="form-input" min="0" max="16">
                </div>
                <div class="form-group">
                    <label class="form-label">রতি</label>
                    <input id="mortgage-roti" type="number" value="0" class="form-input" min="0" max="4">
                </div>
                <div class="form-group">
                    <label class="form-label">পয়েন্ট</label>
                    <input id="mortgage-point" type="number" value="0" class="form-input" min="0" max="6">
                </div>
            </div>
             <p class="text-sm text-gray-300 mt-1">
                মোট গ্রাম: <span id="mortgage-grams-output" class="text-yellow-300 font-bold">০</span> |
                মোট ভরি: <span id="mortgage-vori-output" class="text-yellow-300 font-bold">০</span>
            </p>

            <div class="form-group">
                <label class="form-label">মূল ঋণ</label>
                <input id="mortgage-amount" type="number" class="form-input" required min="1">
            </div>

            <div class="form-group">
                <label class="form-label">মাসিক সুদের হার (%)</label>
                <input id="mortgage-rate" type="number" value="5" class="form-input" required min="0.1" step="0.1">
            </div>

            <div class="flex justify-end gap-3 mt-4">
                <button type="button"
                    onclick="document.getElementById('new-mortgage-modal').style.display='none'"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg">বাতিল</button>

                <button type="submit" class="btn-gold w-auto">সংরক্ষণ</button>
            </div>

        </form>

    </div>
</div>

<div id="redeem-mortgage-modal" class="modal">
    </div>

<div id="message-box"
     class="fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white z-50 transition-transform duration-300 transform translate-x-full"
     style="display:none; background-color: #333;">
</div>

<script type="module">

/* ------------------------------------------
   FIREBASE IMPORTS & CONFIG (Placeholders)
------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
    getFirestore,
    doc,
    setDoc,
    addDoc,
    onSnapshot,
    collection,
    query,
    where,
    orderBy,
    serverTimestamp,
    updateDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- PLACEHOLDER CONFIG (You must replace these with your actual Firebase project configuration) ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY", // <--- এটি পরিবর্তন করুন
  authDomain: "YOUR_AUTH_DOMAIN", // <--- এটি পরিবর্তন করুন
  projectId: "YOUR_PROJECT_ID", // <--- এটি পরিবর্তন করুন
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID" // <--- এটি পরিবর্তন করুন
};
const appId = firebaseConfig.appId;
// ----------------------------------------------------------------------------------------------------

/* ------------------------------------------
   GLOBAL VARIABLES
------------------------------------------- */
let app, db, auth;
let userId = null;
let isAuthReady = false;

let currentGoldRatePerVori = 100000; // Default Rate
let allTransactions = [];
let allMortgages = [];
let allParties = {};

const GRAMS_PER_VORI = 11.664;
const ROTI_PER_ANA = 4;
const POINT_PER_ROTI = 6;
const ANA_PER_VORI = 16;
const POINT_PER_VORI = ANA_PER_VORI * ROTI_PER_ANA * POINT_PER_ROTI;

/* ------------------------------------------
   UTILITY FUNCTIONS
------------------------------------------- */

// Show small Toast Message
window.showMessage = function (msg, type = "success") {
    const box = document.getElementById("message-box");
    box.textContent = msg;
    box.style.backgroundColor =
        type === "error"
            ? "#c53030"
            : type === "success"
            ? "#38a169"
            : "#555";

    box.style.display = "block";
    box.style.transform = "translateX(0)";
    setTimeout(() => {
        box.style.transform = "translateX(100%)";
        box.style.display = "none";
    }, 3000);
};

// Convert weight → Grams
function voriToGrams(v, a, r, p) {
    v = parseFloat(v) || 0;
    a = parseFloat(a) || 0;
    r = parseFloat(r) || 0;
    p = parseFloat(p) || 0;

    const totalPoints =
        v * POINT_PER_VORI +
        a * ROTI_PER_ANA * POINT_PER_ROTI +
        r * POINT_PER_ROTI +
        p;

    const totalVori = totalPoints / POINT_PER_VORI;
    return parseFloat((totalVori * GRAMS_PER_VORI).toFixed(3));
}

// Convert weight → Decimal Vori
function voriToDecimal(v, a, r, p) {
    v = parseFloat(v) || 0;
    a = parseFloat(a) || 0;
    r = parseFloat(r) || 0;
    p = parseFloat(p) || 0;

    const totalPoints =
        v * POINT_PER_VORI +
        a * ROTI_PER_ANA * POINT_PER_ROTI +
        r * POINT_PER_ROTI +
        p;

    return parseFloat((totalPoints / POINT_PER_VORI).toFixed(4));
}

// Convert Currency
const formatCurrency = (amount) =>
    (amount || 0)
        .toLocaleString("bn-BD", {
            style: "currency",
            currency: "BDT",
            minimumFractionDigits: 0,
        })
        .replace("৳", "৳ ");

// Calculate Total Cost for Purchase/Sale
function calculateWeightAndCost(voriId, anaId, rotiId, pointId, pricePerVoriId, chargeId, outputGrams, outputVori, outputCost) {
    const V = document.getElementById(voriId).value;
    const A = document.getElementById(anaId).value;
    const R = document.getElementById(rotiId).value;
    const P = document.getElementById(pointId).value;

    const grams = voriToGrams(V, A, R, P);
    const voriDecimal = voriToDecimal(V, A, R, P);

    // Update weight outputs
    const gramsEl = document.getElementById(outputGrams);
    if(gramsEl) gramsEl.textContent = grams.toFixed(3);
    const voriEl = document.getElementById(outputVori);
    if(voriEl) voriEl.textContent = voriDecimal.toFixed(4);

    // Calculate cost only if relevant elements exist
    if (outputCost) {
        const pricePerVori = parseFloat(document.getElementById(pricePerVoriId)?.value) || 0;
        const charge = parseFloat(document.getElementById(chargeId)?.value) || 0;

        const totalCost = (voriDecimal * pricePerVori) + charge;
        document.getElementById(outputCost).textContent = formatCurrency(Math.round(totalCost));

        return { grams, voriDecimal, totalCost: Math.round(totalCost) };
    }


    return { grams, voriDecimal, totalCost: 0 };
}

// Set up listeners for weight inputs
function setupWeightListeners(prefix) {
    const inputs = ['vori', 'ana', 'roti', 'point'];
    const ids = inputs.map(id => `${prefix}-${id}`);

    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', () => {
                if (prefix === 'purchase') {
                    calculateWeightAndCost('purchase-vori', 'purchase-ana', 'purchase-roti', 'purchase-point', 'purchase-price-per-vori', 'purchase-making-charge', 'purchase-grams-output', 'purchase-vori-output', 'purchase-total-cost');
                } else if (prefix === 'sale') {
                    calculateWeightAndCost('sale-vori', 'sale-ana', 'sale-roti', 'sale-point', 'sale-price-per-vori', 'sale-charge-profit', 'sale-grams-output', 'sale-vori-output', 'sale-total-cost');
                } else if (prefix === 'mortgage') {
                    // Mortgage doesn't have a total cost output in this function
                    calculateWeightAndCost('mortgage-vori', 'mortgage-ana', 'mortgage-roti', 'mortgage-point', null, null, 'mortgage-grams-output', 'mortgage-vori-output', null);
                }
            });
        }
    });

    // Set up listeners for price/charge inputs for cost calculation
    const priceInputs = [`${prefix}-price-per-vori`, `${prefix}-making-charge`, `${prefix}-charge-profit`];
    priceInputs.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            el.addEventListener('input', () => {
                if (prefix === 'purchase') {
                    calculateWeightAndCost('purchase-vori', 'purchase-ana', 'purchase-roti', 'purchase-point', 'purchase-price-per-vori', 'purchase-making-charge', 'purchase-grams-output', 'purchase-vori-output', 'purchase-total-cost');
                } else if (prefix === 'sale') {
                    calculateWeightAndCost('sale-vori', 'sale-ana', 'sale-roti', 'sale-point', 'sale-price-per-vori', 'sale-charge-profit', 'sale-grams-output', 'sale-vori-output', 'sale-total-cost');
                }
            });
        }
    });
}

// Mortgage Interest Calculation
function calculateInterest(loanAmount, ratePercent, startDate) {
    // Ensure startDate is a Date object (if coming from Firestore Timestamp)
    const start = startDate.toDate ? startDate.toDate() : new Date(startDate);
    const now = new Date();
    
    // Check if start date is in the future (shouldn't happen for active mortgages)
    if (start > now) return 0;
    
    const diffTime = Math.abs(now - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    // Daily Rate = Monthly Rate / 30
    const dailyRate = (ratePercent / 100) / 30;
    const totalInterest = loanAmount * dailyRate * diffDays;

    return Math.round(totalInterest);
}


/* ------------------------------------------
   FIREBASE INITIALIZATION
------------------------------------------- */
async function initFirebase() {
    if (firebaseConfig.apiKey === "YOUR_API_KEY") {
        showMessage("ERROR: Firebase কনফিগারেশন আপডেট করুন।", "error");
        return;
    }

    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    // Using Anonymous Sign-in
    await signInAnonymously(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userId = user.uid;
            isAuthReady = true;
            startListeners();
        } else {
            showMessage("ইউজার অথেন্টিকেশন ব্যর্থ হয়েছে।", "error");
        }
    });
}

/* ------------------------------------------
   REAL-TIME LISTENERS
------------------------------------------- */

function startListeners() {
    // 1. Listen to Gold Rate
    const goldDocRef = doc(db, "artifacts", appId, "public", "data", "config", "gold_rate");
    onSnapshot(goldDocRef, (snap) => {
        if (snap.exists()) {
            currentGoldRatePerVori = snap.data().rate || 0;
            document.getElementById("current-gold-rate").textContent =
                `বর্তমান রেট: ${formatCurrency(currentGoldRatePerVori)}`;
        }
        updateDashboard();
    });

    // 2. Listen to transactions
    const q = query(
        collection(db, "artifacts", appId, "public", "data", "transactions"),
        orderBy("timestamp", "desc")
    );
    onSnapshot(q, (snap) => {
        allTransactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateDashboard();
        updateCashTable();
        updateRecentTransactions();
        updatePartyList();
    });

    // 3. Listen to mortgages
    const mq = query(
        collection(db, "artifacts", appId, "public", "data", "mortgages"),
        where("status", "==", "Active")
    );
    onSnapshot(mq, (snap) => {
        allMortgages = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateMortgageTable();
        // Update dashboard here as well since it needs total mortgage/interest
        updateDashboard(); 
    });
}

/* ------------------------------------------
   UPDATE UI SECTIONS
------------------------------------------- */

// Dashboard info
function updateDashboard() {
    let totalInvestment = 0,
        totalExpense = 0,
        totalPurchaseCost = 0,
        totalSaleRevenue = 0,
        totalStockGrams = 0;
    
    // Summing up transactions
    allTransactions.forEach((t) => {
        if (t.type === "Investment") totalInvestment += t.amount;
        if (t.type === "Expense") totalExpense += t.amount;
        if (t.type === "Purchase") {
            totalPurchaseCost += t.amount;
            totalStockGrams += t.grams;
        }
        if (t.type === "Sale") {
            totalSaleRevenue += t.amount;
            totalStockGrams += t.grams; // grams is already negative for sale
        }
    });
    
    // Summing up active mortgages
    let totalMortgageValue = 0;
    let totalAccruedInterest = 0;
    allMortgages.forEach((m) => {
        totalMortgageValue += m.amount;
        totalAccruedInterest += calculateInterest(m.amount, m.rate, m.timestamp);
    });
    
    // Update Dashboard elements
    document.getElementById("total-investment").textContent = formatCurrency(totalInvestment);
    document.getElementById("total-expense").textContent = formatCurrency(totalExpense);
    document.getElementById("dashboard-total-mortgage").textContent = formatCurrency(totalMortgageValue);
    document.getElementById("dashboard-total-interest").textContent = formatCurrency(totalAccruedInterest);
    
    // Update Stock elements
    document.getElementById("stock-grams").textContent = totalStockGrams.toFixed(3) + " gm";
    const totalVori = totalStockGrams / GRAMS_PER_VORI;
    document.getElementById("stock-market-value").textContent = formatCurrency(Math.round(totalVori * currentGoldRatePerVori));
    document.getElementById("stock-vori").textContent = totalVori.toFixed(3) + " ভরি";
    
    // Update Cash section totals
    document.getElementById("cash-total-investment").textContent = formatCurrency(totalInvestment);
    document.getElementById("cash-total-expense").textContent = formatCurrency(totalExpense);
    
    // Update Reports section totals
    document.getElementById("report-total-sale-revenue").textContent = formatCurrency(totalSaleRevenue);
    document.getElementById("report-total-purchase-cost").textContent = formatCurrency(totalPurchaseCost);
    document.getElementById("report-net-profit").textContent = formatCurrency(totalSaleRevenue - totalPurchaseCost);
}

// Recent transactions
function updateRecentTransactions() {
    const body = document.getElementById("recent-transactions-body");
    body.innerHTML = "";

    const limitedTransactions = allTransactions.slice(0, 10);

    if (limitedTransactions.length === 0) {
        body.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400">কোন লেনদেন নেই</td></tr>`;
        return;
    }

    limitedTransactions.forEach((t) => {
        const tr = document.createElement("tr");
        const date = t.timestamp ? new Date(t.timestamp.toDate()).toLocaleDateString("bn-BD") : 'N/A';
        const description = t.description || (t.type_bn || t.type);

        tr.innerHTML = `
            <td>${date}</td>
            <td>${t.type_bn || t.type}</td>
            <td class="${t.amount > 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(t.amount)}</td>
            <td>${description}</td>
        `;
        body.appendChild(tr);
    });
}

// Cash table update
function updateCashTable() {
    const body = document.getElementById("cash-list-body");
    body.innerHTML = "";

    const cashTransactions = allTransactions
        .filter((t) => t.type === "Expense" || t.type === "Investment");

    if (cashTransactions.length === 0) {
        body.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400">কোনো লেনদেন নেই</td></tr>`;
        return;
    }

    cashTransactions.forEach((t) => {
        const tr = document.createElement("tr");
        const date = t.timestamp ? new Date(t.timestamp.toDate()).toLocaleDateString("bn-BD") : 'N/A';
        const typeBn = t.type === "Investment" ? "বিনিয়োগ" : "খরচ";

        tr.innerHTML = `
            <td>${date}</td>
            <td>${typeBn}</td>
            <td class="${t.type === "Investment" ? 'text-green-400' : 'text-red-400'}">${formatCurrency(t.amount)}</td>
            <td>${t.description}</td>
        `;
        body.appendChild(tr);
    });
}

// Party list
window.filterPartyList = function() {
    allParties = {};
    
    // Aggregate data for Parties from transactions
    allTransactions.forEach((t) => {
        if (t.details?.customer && (t.type === 'Sale' || t.type === 'Redeem')) {
            const name = t.details.customer;
            if (!allParties[name]) {
                allParties[name] = { name: name, amount: 0, type: "গ্রাহক", phone: t.details.phone || "N/A" };
            }
            allParties[name].amount += t.amount;
        }
        if (t.details?.supplier && t.type === 'Purchase') {
            const name = t.details.supplier;
            if (!allParties[name]) {
                allParties[name] = { name: name, amount: 0, type: "সরবরাহকারী", phone: "N/A" };
            }
            allParties[name].amount += t.amount;
        }
    });

    const body = document.getElementById("party-list-body");
    body.innerHTML = "";
    
    const filter = document.getElementById("party-type-filter").value;

    const filteredParties = Object.values(allParties).filter(p => filter === 'All' || p.type === filter);

    if (filteredParties.length === 0) {
        body.innerHTML = `<tr><td colspan="4" class="text-center text-gray-400">কোনো ডেটা নেই</td></tr>`;
        return;
    }

    filteredParties.forEach((p) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${p.name}</td>
            <td>${p.type}</td>
            <td>${formatCurrency(p.amount)}</td>
            <td>${p.phone}</td>
        `;
        body.appendChild(tr);
    });
}; // Expose to HTML

// Mortgage list and stats
function updateMortgageTable() {
    const body = document.getElementById("mortgage-list-body");
    body.innerHTML = "";

    let totalMortgageValue = 0;
    let totalAccruedInterest = 0;

    if (allMortgages.length === 0) {
        body.innerHTML = `<tr><td colspan="6" class="text-center text-gray-400">কোনো বন্ধক নেই</td></tr>`;
    }

    allMortgages.forEach((m) => {
        const accruedInterest = calculateInterest(m.amount, m.rate, m.timestamp);
        totalMortgageValue += m.amount;
        totalAccruedInterest += accruedInterest;

        const tr = document.createElement("tr");
        const date = m.timestamp ? new Date(m.timestamp.toDate()).toLocaleDateString("bn-BD") : 'N/A';
        const voriDisplay = m.voriDecimal ? m.voriDecimal.toFixed(3) : (m.grams / GRAMS_PER_VORI).toFixed(3);
        
        tr.innerHTML = `
            <td>${m.customer}</td>
            <td>${voriDisplay}</td>
            <td>${formatCurrency(m.amount)}</td>
            <td>${m.rate.toFixed(1)}%</td>
            <td>${date}</td>
            <td>
                <button onclick="showRedeemModal('${m.id}', '${m.customer}', ${m.amount}, ${accruedInterest}, ${m.rate})" 
                    class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">পরিশোধ</button>
            </td>
        `;
        body.appendChild(tr);
    });
    
    // Update Mortgage section stats
    document.getElementById("total-mortgage-value").textContent = formatCurrency(totalMortgageValue);
    document.getElementById("total-accrued-interest").textContent = formatCurrency(totalAccruedInterest);
}

/* ------------------------------------------
   FIREBASE WRITE OPERATIONS
------------------------------------------- */
async function addTransaction(data) {
    if (!isAuthReady) {
        showMessage("Authentication not ready. Please wait.", "error");
        return false;
    }
    try {
        await addDoc(
            collection(db, "artifacts", appId, "public", "data", "transactions"),
            {
                ...data,
                timestamp: serverTimestamp(),
                userId: userId,
            }
        );
        return true;
    } catch (e) {
        showMessage(`লেনদেন সংরক্ষণে ব্যর্থ: ${e.message}`, "error");
        return false;
    }
}

async function updateGoldRate(rate) {
    if (!isAuthReady) return showMessage("Authentication not ready.", "error");
    try {
        const goldDocRef = doc(db, "artifacts", appId, "public", "data", "config", "gold_rate");
        await setDoc(goldDocRef, { rate: parseFloat(rate) });
        showMessage("স্বর্ণের রেট সফলভাবে আপডেট করা হয়েছে।", "success");
    } catch (e) {
        showMessage(`রেট আপডেটে ব্যর্থ: ${e.message}`, "error");
    }
}


/* ------------------------------------------
   FORM SUBMISSIONS
------------------------------------------- */

// Gold Rate Update
document.getElementById("gold-rate-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const rate = document.getElementById("gold-rate-input").value;
    if (rate && parseFloat(rate) > 0) {
        await updateGoldRate(rate);
        document.getElementById("gold-rate-input").value = '';
    } else {
        showMessage("সঠিক রেট ইনপুট দিন।", "error");
    }
});


// Purchase
document.getElementById("purchase-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const { grams, voriDecimal, totalCost } = calculateWeightAndCost('purchase-vori', 'purchase-ana', 'purchase-roti', 'purchase-point', 'purchase-price-per-vori', 'purchase-making-charge', 'purchase-grams-output', 'purchase-vori-output', 'purchase-total-cost');
    
    if (totalCost <= 0 || grams <= 0) {
        return showMessage("ক্রয়ের ওজন এবং মোট মূল্য অবশ্যই শূন্যের বেশি হতে হবে।", "error");
    }

    const data = {
        type: "Purchase",
        type_bn: "ক্রয়",
        grams: grams, // Stock increases
        amount: totalCost, // Cash Out/Investment
        description: `${document.getElementById('purchase-gold-type').value} ক্রয়: ${voriDecimal.toFixed(2)} ভরি`,
        details: {
            voriDecimal,
            pricePerVori: parseFloat(document.getElementById('purchase-price-per-vori').value),
            makingCharge: parseFloat(document.getElementById('purchase-making-charge').value),
            supplier: document.getElementById('purchase-supplier').value,
        }
    };

    if (await addTransaction(data)) {
        showMessage("ক্রয় সফলভাবে সংরক্ষণ হয়েছে", "success");
        e.target.reset();
        // Recalculate to reset outputs visually
        calculateWeightAndCost('purchase-vori', 'purchase-ana', 'purchase-roti', 'purchase-point', 'purchase-price-per-vori', 'purchase-making-charge', 'purchase-grams-output', 'purchase-vori-output', 'purchase-total-cost');
    }
});

// Sale
document.getElementById("sale-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const { grams, voriDecimal, totalCost } = calculateWeightAndCost('sale-vori', 'sale-ana', 'sale-roti', 'sale-point', 'sale-price-per-vori', 'sale-charge-profit', 'sale-grams-output', 'sale-vori-output', 'sale-total-cost');
    
    if (totalCost <= 0 || grams <= 0) {
        return showMessage("বিক্রয়ের ওজন এবং মোট মূল্য অবশ্যই শূন্যের বেশি হতে হবে।", "error");
    }

    const data = {
        type: "Sale",
        type_bn: "বিক্রয়",
        grams: -grams, // Stock decreases
        amount: totalCost, // Cash In/Revenue
        description: `বিক্রয়: ${voriDecimal.toFixed(2)} ভরি`,
        details: {
            voriDecimal,
            pricePerVori: parseFloat(document.getElementById('sale-price-per-vori').value),
            chargeProfit: parseFloat(document.getElementById('sale-charge-profit').value),
            customer: document.getElementById('sale-customer').value,
            phone: document.getElementById('sale-phone').value,
        },
    };

    if (await addTransaction(data)) {
        showMessage("বিক্রয় এন্ট্রি সফল হয়েছে", "success");
        e.target.reset();
        calculateWeightAndCost('sale-vori', 'sale-ana', 'sale-roti', 'sale-point', 'sale-price-per-vori', 'sale-charge-profit', 'sale-grams-output', 'sale-vori-output', 'sale-total-cost');
    }
});

// Cash transaction
document
    .getElementById("cash-transaction-form")
    .addEventListener("submit", async (e) => {
        e.preventDefault();

        const type = document.getElementById('cash-type').value;
        const amount = parseFloat(document.getElementById('cash-amount').value);
        const description = document.getElementById('cash-description').value;

        if (amount <= 0) {
            return showMessage("পরিমাণ অবশ্যই শূন্যের বেশি হতে হবে।", "error");
        }

        const data = {
            type,
            type_bn: type === "Investment" ? "বিনিয়োগ" : "খরচ",
            amount,
            description,
        };

        if (await addTransaction(data)) {
            showMessage("লেনদেন সংরক্ষণ হয়েছে", "success");
            e.target.reset();
        }
    });

// New Mortgage
document.getElementById("new-mortgage-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const { grams, voriDecimal } = calculateWeightAndCost('mortgage-vori', 'mortgage-ana', 'mortgage-roti', 'mortgage-point', null, null, 'mortgage-grams-output', 'mortgage-vori-output', null);

    const amount = parseFloat(document.getElementById('mortgage-amount').value);
    const rate = parseFloat(document.getElementById('mortgage-rate').value);
    const customer = document.getElementById('mortgage-customer').value;

    if (amount <= 0 || grams <= 0) {
        return showMessage("ওজন এবং ঋণের পরিমাণ শূন্যের বেশি হতে হবে।", "error");
    }

    try {
        await addDoc(
            collection(db, "artifacts", appId, "public", "data", "mortgages"),
            {
                customer,
                grams,
                voriDecimal,
                amount,
                rate,
                timestamp: serverTimestamp(),
                status: "Active",
                userId: userId,
            }
        );
        showMessage("নতুন বন্ধক সফলভাবে সংরক্ষণ করা হয়েছে", "success");
        e.target.reset();
        document.getElementById('new-mortgage-modal').style.display = 'none';
        // Recalculate to reset outputs visually
        calculateWeightAndCost('mortgage-vori', 'mortgage-ana', 'mortgage-roti', 'mortgage-point', null, null, 'mortgage-grams-output', 'mortgage-vori-output', null);
    } catch (e) {
        showMessage(`বন্ধক সংরক্ষণে ব্যর্থ: ${e.message}`, "error");
    }
});

/* ------------------------------------------
   MORTGAGE REDEEM LOGIC
------------------------------------------- */

window.showRedeemModal = function(mortgageId, customer, loanAmount, interest, rate) {
    const modal = document.getElementById('redeem-mortgage-modal');
    const totalDue = loanAmount + interest;

    modal.innerHTML = `
        <div class="modal-card">
            <h2 class="text-lg font-semibold mb-4 text-[var(--gold)]">বন্ধক পরিশোধ</h2>
            <p class="mb-2">গ্রাহক: <span class="text-yellow-300">${customer}</span></p>
            <p class="mb-2">মূল ঋণ: <span class="text-blue-400">${formatCurrency(loanAmount)}</span></p>
            <p class="mb-2">বকেয়া সুদ: <span class="text-purple-400">${formatCurrency(interest)}</span></p>
            <p class="text-xl font-bold mt-4">মোট পরিশোধ: <span class="text-green-400">${formatCurrency(totalDue)}</span></p>

            <form id="redeem-form">
                <div class="form-group mt-4">
                    <label class="form-label">পরিশোধের পরিমাণ</label>
                    <input id="redeem-amount-input" type="number" class="form-input" value="${totalDue}" min="${totalDue}" required>
                </div>

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="document.getElementById('redeem-mortgage-modal').style.display='none'"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg">বাতিল</button>
                    <button type="submit" class="btn-gold w-auto">পরিশোধ নিশ্চিত করুন</button>
                </div>
            </form>
        </div>
    `;
    modal.style.display = 'flex';

    document.getElementById('redeem-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const paidAmount = parseFloat(document.getElementById('redeem-amount-input').value);
        if (paidAmount < totalDue) {
            return showMessage("পরিশোধের পরিমাণ মোট বকেয়ার চেয়ে কম হতে পারবে না।", "error");
        }
        await redeemMortgage(mortgageId, loanAmount, interest, paidAmount, customer, rate);
    });
}

async function redeemMortgage(mortgageId, loanAmount, interestAmount, paidAmount, customer, rate) {
    if (!isAuthReady) return showMessage("Authentication not ready.", "error");

    try {
        // 1. Update Mortgage status to Redeemed
        const mortgageRef = doc(db, "artifacts", appId, "public", "data", "mortgages", mortgageId);
        await updateDoc(mortgageRef, {
            status: "Redeemed",
            redemptionDate: serverTimestamp(),
            paidAmount,
            finalInterest: interestAmount
        });

        // 2. Add Transaction entry for the redemption (Cash In)
        const transactionData = {
            type: "Redeem",
            type_bn: "বন্ধক পরিশোধ",
            amount: paidAmount, // Total cash inflow
            description: `বন্ধক পরিশোধ (ঋণ: ${formatCurrency(loanAmount)}, সুদ: ${formatCurrency(interestAmount)})`,
            details: {
                mortgageId,
                customer,
                loanAmount,
                interestAmount,
                rate
            }
        };
        await addTransaction(transactionData);

        showMessage("বন্ধক সফলভাবে পরিশোধ করা হয়েছে।", "success");
        document.getElementById('redeem-mortgage-modal').style.display = 'none';

    } catch (e) {
        showMessage(`পরিশোধ প্রক্রিয়া ব্যর্থ: ${e.message}`, "error");
    }
}

/* ------------------------------------------
   PAGE NAVIGATION
------------------------------------------- */
window.showPage = function (id, btn) {
    document.querySelectorAll(".page").forEach((p) => (p.style.display = "none"));
    document.getElementById(id).style.display = "block";

    document.querySelectorAll(".nav-btn").forEach((b) =>
        b.classList.remove("active")
    );
    btn.classList.add("active");
};

/* ------------------------------------------
   INIT APP
------------------------------------------- */
window.onload = function () {
    // Setup listeners for weight/cost calculations on load
    setupWeightListeners('purchase');
    setupWeightListeners('sale');
    setupWeightListeners('mortgage');
    
    // Also setup listener for party filter change (though function is exposed as window.filterPartyList)
    document.getElementById("party-type-filter").addEventListener('change', window.filterPartyList);

    initFirebase();
    showPage("dashboard", document.querySelector(".nav-btn"));
};

</script>

</div> </body>
</html>
